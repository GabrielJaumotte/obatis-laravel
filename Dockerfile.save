FROM php:8.3-fpm

# (extrait simplifié)
WORKDIR /var/www

# Copie des fichiers
COPY . .

# Installation de dépendances
RUN apt-get update && apt-get install -y \
    git unzip curl libzip-dev \
    && docker-php-ext-install pdo pdo_mysql zip
    && composer install --no-interaction --prefer-dist --optimize-autoloader

# Copier l’entrypoint et lui donner les droits
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Installation des dépendances Laravel
RUN composer install --no-interaction --prefer-dist --optimize-autoloader

# Crée les répertoires de logs + cache et set les permissions
RUN mkdir -p storage/logs bootstrap/cache \
    && chown -R www-data:www-data storage bootstrap/cache

# Permissions
RUN chown -R www-data:www-data /var/www/storage /var/www/bootstrap/cache

# Génération de la clé Laravel
RUN php artisan key:generate

# Cache des configs
RUN php artisan config:cache

# Redirection des logs Laravel
RUN ln -sf /dev/stdout /var/www/storage/logs/laravel.log

USER www-data
